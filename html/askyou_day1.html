<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è³ªå•ãƒšãƒ¼ã‚¸</title>
    <!-- Tailwind CSS CDNã‚’èª­ã¿è¾¼ã¿ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8; /* è–„ã„ã‚°ãƒ¬ãƒ¼ã®èƒŒæ™¯ */
            color: #333;
        }
        /* ã‚«ã‚¹ã‚¿ãƒ ã‚¹ã‚¿ã‚¤ãƒ«ã§ç”»åƒã¨ãƒ†ã‚­ã‚¹ãƒˆã®å‚ç›´æ–¹å‘ã®é…ç½®ã‚’èª¿æ•´ */
        .question-item {
            display: flex;
            align-items: flex-start; /* å‚ç›´æ–¹å‘ä¸Šæƒãˆã«å¤‰æ›´ */
            gap: 1rem; /* ç”»åƒã¨ãƒ†ã‚­ã‚¹ãƒˆã®é–“ã®ã‚¹ãƒšãƒ¼ã‚¹ */
        }
        /* ç·¨é›†ãƒ¢ãƒ¼ãƒ‰æ™‚ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .question-item.editing {
            border: 2px dashed #a0aec0; /* ç·¨é›†ä¸­ã®æ ç·š */
            padding: 1rem;
        }
        /* ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒœãƒƒã‚¯ã‚¹ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        #messageBox {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #4CAF50; /* Green */
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
            min-width: 300px;
            text-align: center;
        }
        #messageBox.error {
            background-color: #f44336; /* Red */
        }
        #messageBox.show {
            opacity: 1;
        }

        /* ç”»åƒã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        #imageOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7); /* åŠé€æ˜ã®æš—ã„èƒŒæ™¯ */
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 999; /* ä»–ã®è¦ç´ ã‚ˆã‚Šæ‰‹å‰ã«è¡¨ç¤º */
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
        }
        #imageOverlay.show {
            opacity: 1;
            visibility: visible;
        }
        #imageOverlay img {
            max-width: 90vw; /* ãƒ“ãƒ¥ãƒ¼ãƒãƒ¼ãƒˆã®å¹…ã®90% */
            max-height: 90vh; /* ãƒ“ãƒ¥ãƒ¼ãƒãƒ¼ãƒˆã®é«˜ã•ã®90% */
            border-radius: 12px;
            object-fit: contain; /* ã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”ã‚’ç¶­æŒã—ã¦ãƒ•ã‚£ãƒƒãƒˆ */
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.4);
            /* å°ã•ã„ç”»åƒã‚’ã‚ã‚‹ç¨‹åº¦æ‹¡å¤§ã—ã¦è¡¨ç¤ºã™ã‚‹ãŸã‚ã«min-heightã‚’è¨­å®š */
            min-height: 60vh; /* ãƒ“ãƒ¥ãƒ¼ãƒãƒ¼ãƒˆã®é«˜ã•ã®60%ã¾ã§æ‹¡å¤§ */
            min-width: 60vw; /* ãƒ“ãƒ¥ãƒ¼ãƒãƒ¼ãƒˆã®å¹…ã®60%ã¾ã§æ‹¡å¤§ */
            width: auto;
            height: auto;
        }

        #closeOverlayButton {
            position: absolute;
            top: 20px;
            right: 20px;
            background-color: rgba(255, 255, 255, 0.3);
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            font-size: 1.5rem;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out;
        }
        #closeOverlayButton:hover {
            background-color: rgba(255, 255, 255, 0.5);
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center justify-center p-4">

    <!-- ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒœãƒƒã‚¯ã‚¹ -->
    <div id="messageBox" class="hidden"></div>

    <!-- èƒŒæ™¯éŸ³æ¥½ -->
    <!-- loopå±æ€§ã¯ã€éŸ³æ¥½ãŒè‡ªç„¶ã«çµ‚äº†ã—ãŸå ´åˆã®è‡ªå‹•ãƒ«ãƒ¼ãƒ—ã‚’ä¿è¨¼ã—ã¾ã™ãŒã€
         endedã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã§5ç§’ã®é…å»¶ã‚’æŒŸã‚€ã“ã¨ã§ã€
         ã“ã®ãƒ«ãƒ¼ãƒ—å‹•ä½œã‚’ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã—ã¾ã™ã€‚ -->
    <audio id="backgroundMusic" src="/pwa-Ksite2/music/week.mp3" autoplay loop></audio>

    <!-- éŸ³æ¥½å†ç”Ÿ/ä¸€æ™‚åœæ­¢ãƒœã‚¿ãƒ³ -->
    <div class="absolute top-4 right-4">
        <button id="musicToggleButton" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-full shadow-lg transition duration-300 ease-in-out transform hover:scale-105">
            ğŸµ éŸ³æ¥½ã‚’åœæ­¢
        </button>
    </div>

    <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚³ãƒ³ãƒ†ãƒŠ -->
    <div class="bg-white p-8 rounded-xl shadow-2xl max-w-2xl w-full space-y-8">
        <h1 class="text-4xl font-extrabold text-center text-gray-800 mb-8">è³ªå•ã‚¿ã‚¤ãƒ </h1>

        <!-- ä¸€æ™‚ä¿å­˜ãƒœã‚¿ãƒ³ -->
        <div class="text-right mb-4">
            <button id="temporarySaveButton" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-full shadow-lg transition duration-300 ease-in-out transform hover:scale-105">
                ğŸ’¾ å›ç­”ã‚’ä¸€æ™‚ä¿å­˜
            </button>
        </div>

        <!-- æ—¥æ™‚é¸æŠ -->
        <div class="mb-6">
            <label for="dateTimeInput" class="block text-lg font-semibold text-gray-700 mb-2">æ—¥æ™‚ã‚’é¸æŠ:</label>
            <input type="datetime-local" id="dateTimeInput" class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-400 transition duration-200 text-gray-800">
        </div>

        <!-- è³ªå•ã‚’å‹•çš„ã«æŒ¿å…¥ã™ã‚‹ã‚³ãƒ³ãƒ†ãƒŠ -->
        <div id="questionsContainer" class="space-y-8">
            <!-- è³ªå•ã¯JavaScriptã«ã‚ˆã£ã¦ã“ã“ã«æŒ¿å…¥ã•ã‚Œã¾ã™ -->
        </div>

        <!-- æ–°è¦è³ªå•è¿½åŠ ãƒœã‚¿ãƒ³ (ç·¨é›†ãƒ¢ãƒ¼ãƒ‰æ™‚ã®ã¿è¡¨ç¤º) -->
        <div id="addNewQuestionContainer" class="text-center mt-4 hidden">
            <button id="addNewQuestionButton" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-6 rounded-full shadow-md transition duration-300 ease-in-out transform hover:scale-105">
                + æ–°è¦è³ªå•ã‚’è¿½åŠ 
            </button>
        </div>

        <div class="text-center mt-8 space-y-4">
            <button id="saveAnswersButton" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-8 rounded-full shadow-xl transition duration-300 ease-in-out transform hover:scale-105">
                å›ç­”ã‚’ä¿å­˜
            </button>
            <div class="flex justify-center space-x-2">
                <button id="outputQuestionsButton" class="bg-gray-600 hover:bg-gray-700 text-white text-sm py-2 px-4 rounded-full shadow-md transition duration-300 ease-in-out transform hover:scale-105">
                    å‡ºåŠ›
                </button>
                <button id="inputQuestionsButton" class="bg-gray-600 hover:bg-gray-700 text-white text-sm py-2 px-4 rounded-full shadow-md transition duration-300 ease-in-out transform hover:scale-105">
                    å…¥åŠ›
                </button>
                <button id="editQuestionsButton" class="bg-gray-600 hover:bg-gray-700 text-white text-sm py-2 px-4 rounded-full shadow-md transition duration-300 ease-in-out transform hover:scale-105">
                    ç·¨é›†
                </button>
            </div>
        </div>
    </div>

    <!-- ç”»åƒæ‹¡å¤§è¡¨ç¤ºã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
    <div id="imageOverlay">
        <img id="enlargedImage" src="" alt="Enlarged Image">
        <button id="closeOverlayButton">âœ•</button>
    </div>

    <script>
        // --- ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ID ---
        // ã“ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’è¤‡æ•°ä½œæˆã™ã‚‹å ´åˆã€localStorageã®ã‚­ãƒ¼ãŒç«¶åˆã—ãªã„ã‚ˆã†ã«
        // å„ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã«ç•°ãªã‚‹IDã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚
        // ä¾‹: 'question_app_instance_1', 'question_app_instance_2', 'question_app_instance_3'
        const APP_ID = 'question_app_instance_1';

        // Define the initial questions data structure
        // This array defines the default questions and their properties.
        const initialQuestionsData = [
            {
                id: 1,
                type: 'text', // ãƒ†ã‚­ã‚¹ãƒˆå…¥åŠ›å½¢å¼
                text: 'è³ªå•ï¼‘ã‚ã„ã†ãˆãŠ',
                image: 'https://placehold.co/80x80/E0E0E0/333333?text=A',
                answerId: 'question1Answer'
            },
            {
                id: 2,
                type: 'radio', // ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³é¸æŠå½¢å¼
                text: 'è³ªå•ï¼’ã‹ããã‘ã“',
                image: 'https://placehold.co/80x80/E0E0E0/333333?text=B',
                options: ['é¸æŠè‚¢ï¼‘', 'é¸æŠè‚¢ï¼’', 'é¸æŠè‚¢ï¼“'],
                answerName: 'q2_choice' // ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ã®nameå±æ€§
            },
            {
                id: 3,
                type: 'textarea', // ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢å½¢å¼
                text: 'è³ªå•ï¼“ã•ã—ã™ã›ã',
                image: 'https://placehold.co/80x80/E0E0E0/333333?text=C',
                answerId: 'question3Answer'
            },
            {
                id: 4,
                type: 'yes_no_maybe', // YES/NO/MAYBEãƒœã‚¿ãƒ³å½¢å¼
                text: 'è³ªå•ï¼”ã“ã‚Œã¯YES/NO/MAYBEã®è³ªå•ã§ã™ã‹ï¼Ÿ',
                image: 'https://placehold.co/80x80/E0E0E0/333333?text=D',
                answerId: 'question4Answer'
            },
            {
                id: 5,
                type: 'maru_batsu', // ãƒãƒ«ãƒ»ãƒãƒ„ãƒœã‚¿ãƒ³å½¢å¼
                text: 'è³ªå•ï¼•ã“ã‚Œã¯æ­£ã—ã„ã§ã™ã‹ï¼Ÿ',
                image: 'https://placehold.co/80x80/E0E0E0/333333?text=E',
                answerId: 'question5Answer'
            },
            {
                id: 6,
                type: 'number_block', // æ•°å­—ãƒ–ãƒ­ãƒƒã‚¯é¸æŠå½¢å¼
                text: 'è³ªå•ï¼–ï¼‘ã‹ã‚‰ï¼‘ï¼ã¾ã§ã®æ•°å­—ã‚’é¸ã‚“ã§ãã ã•ã„ã€‚',
                image: 'https://placehold.co/80x80/E0E0E0/333333?text=F',
                min: 1, // æ•°å­—ã®æœ€å°å€¤
                max: 10, // æ•°å­—ã®æœ€å¤§å€¤
                answerId: 'question6Answer'
            },
            {
                id: 7, // æ–°ã—ã„ID
                type: 'no_answer', // å›ç­”ãªã—å½¢å¼
                text: 'è³ªå•ï¼—ã“ã‚Œã¯å›ç­”ãªã—å½¢å¼ã§ã™ã€‚',
                image: 'https://placehold.co/80x80/E0F0E0/333333?text=G'
                // å›ç­”IDã¯ä¸è¦
            }
        ];

        let currentQuestionsData = []; // This will hold the active questions data, loaded from localStorage or initial.
        let isEditMode = false; // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã®çŠ¶æ…‹ã‚’ç®¡ç†ã™ã‚‹ãƒ•ãƒ©ã‚°

        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒœãƒƒã‚¯ã‚¹è¡¨ç¤ºç”¨ã®é–¢æ•°
        function showMessageBox(message, isError = false) {
            const messageBox = document.getElementById('messageBox');
            messageBox.textContent = message;
            messageBox.classList.remove('hidden', 'error');
            messageBox.classList.add('show');
            if (isError) {
                messageBox.classList.add('error');
            }

            setTimeout(() => {
                messageBox.classList.remove('show');
                messageBox.classList.add('hidden');
            }, 3000); // 3ç§’å¾Œã«éè¡¨ç¤º
        }

        /**
         * æ•°å­—ã®å€¤ã«åŸºã¥ã„ã¦è‰²ã‚’ç”Ÿæˆã™ã‚‹é–¢æ•° (è–„ã„èµ¤ -> è–„ã„é’)
         * @param {number} value - ç¾åœ¨ã®æ•°å­—
         * @param {number} min - ç¯„å›²ã®æœ€å°å€¤
         * @param {number} max - ç¯„å›²ã®æœ€å¤§å€¤
         * @returns {string} RGBã‚«ãƒ©ãƒ¼æ–‡å­—åˆ—
         */
        function getColorForNumber(value, min, max) {
            const normalized = (value - min) / (max - min); // 0ã‹ã‚‰1ã®ç¯„å›²ã«æ­£è¦åŒ–
            
            // è–„ã„èµ¤ (R:255, G:100, B:100) ã‹ã‚‰ è–„ã„é’ (R:100, G:100, B:255) ã¸è£œé–“
            const startR = 255;
            const startG = 100;
            const startB = 100;

            const endR = 100;
            const endG = 100;
            const endB = 255;

            const r = startR + (endR - startR) * normalized;
            const g = startG + (endG - startG) * normalized;
            const b = startB + (endB - startB) * normalized;
            
            return `rgb(${Math.round(r)}, ${Math.round(g)}, ${Math.round(b)})`;
        }

        /**
         * è³ªå•ãƒ‡ãƒ¼ã‚¿ã‚’å…ƒã«HTMLã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã™ã‚‹é–¢æ•°
         */
        function renderQuestions() {
            const questionsContainer = document.getElementById('questionsContainer');
            questionsContainer.innerHTML = ''; // æ—¢å­˜ã®è³ªå•ã‚’ã‚¯ãƒªã‚¢

            currentQuestionsData.forEach((q, index) => {
                const questionItem = document.createElement('div');
                questionItem.classList.add('question-item', 'bg-gray-50', 'p-6', 'rounded-lg', 'shadow-inner');
                questionItem.dataset.questionId = q.id;
                questionItem.dataset.editing = 'false'; // å€‹åˆ¥ã®ç·¨é›†çŠ¶æ…‹ã‚’ç®¡ç†

                // è³ªå•ç”»åƒ
                const img = document.createElement('img');
                img.src = q.image;
                img.alt = `è³ªå•${q.id}ã®ç”»åƒ`;
                img.classList.add('w-20', 'h-20', 'rounded-md', 'shadow-md', 'flex-shrink-0', 'question-image', 'cursor-pointer'); // cursor-pointerã‚’è¿½åŠ 
                // ç”»åƒã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’ã“ã“ã§è¿½åŠ 
                img.addEventListener('click', () => showImageOverlay(img.src));
                questionItem.appendChild(img);

                const flexGrowDiv = document.createElement('div');
                flexGrowDiv.classList.add('flex-grow');

                // è³ªå•æ–‡ã‚³ãƒ³ãƒ†ãƒŠ
                const questionTextContainer = document.createElement('div');
                questionTextContainer.classList.add('mb-2');
                const p = document.createElement('p');
                p.classList.add('text-xl', 'font-semibold', 'text-gray-700', 'question-text');
                p.textContent = q.text;
                questionTextContainer.appendChild(p);
                flexGrowDiv.appendChild(questionTextContainer);

                // å›ç­”å…¥åŠ›/é¸æŠè‚¢ã®ç”Ÿæˆï¼ˆè³ªå•ã‚¿ã‚¤ãƒ—ã«åŸºã¥ãï¼‰
                if (q.type === 'text') {
                    const input = document.createElement('input');
                    input.type = 'text';
                    input.id = q.answerId;
                    input.placeholder = 'ã“ã“ã«å›ç­”ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„';
                    input.classList.add('w-full', 'p-3', 'border', 'border-gray-300', 'rounded-md', 'focus:outline-none', 'focus:ring-2', 'focus:ring-blue-400', 'transition', 'duration-200');
                    flexGrowDiv.appendChild(input);
                } else if (q.type === 'radio') {
                    const choicesDiv = document.createElement('div');
                    choicesDiv.classList.add('space-y-2');
                    q.options.forEach(option => {
                        const label = document.createElement('label');
                        label.classList.add('block', 'text-gray-600');
                        const input = document.createElement('input');
                        input.type = 'radio';
                        input.name = q.answerName;
                        input.value = option;
                        input.classList.add('mr-2');
                        label.appendChild(input);
                        label.appendChild(document.createTextNode(option));
                        choicesDiv.appendChild(label);
                    });
                    flexGrowDiv.appendChild(choicesDiv);
                } else if (q.type === 'textarea') {
                    const textarea = document.createElement('textarea');
                    textarea.id = q.answerId;
                    textarea.placeholder = 'ã“ã“ã«è‡ªç”±å›ç­”ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„';
                    textarea.rows = 3;
                    textarea.classList.add('w-full', 'p-3', 'border', 'border-gray-300', 'rounded-md', 'focus:outline-none', 'focus:ring-2', 'focus:ring-blue-400', 'transition', 'duration-200');
                    flexGrowDiv.appendChild(textarea);
                } else if (q.type === 'yes_no_maybe') {
                    const choicesDiv = document.createElement('div');
                    choicesDiv.classList.add('flex', 'space-x-4', 'mt-2');
                    const options = ['YES', 'NO', 'MAYBE'];
                    const colors = {
                        'YES': 'bg-blue-600 hover:bg-blue-700 text-white',
                        'NO': 'bg-red-600 hover:bg-red-700 text-white',
                        'MAYBE': 'bg-gray-300 hover:bg-gray-400 text-gray-800'
                    };
                    options.forEach(option => {
                        const button = document.createElement('button');
                        button.textContent = option;
                        button.dataset.value = option;
                        button.classList.add('q4-button', 'font-bold', 'py-2', 'px-4', 'rounded-full', 'shadow-md', 'transition', 'duration-200', ...colors[option].split(' '));
                        button.addEventListener('click', function() {
                            document.querySelectorAll('.q4-button').forEach(btn => {
                                btn.classList.remove('ring-2', 'ring-offset-2', 'ring-blue-500');
                            });
                            this.classList.add('ring-2', 'ring-offset-2', 'ring-blue-500');
                            document.getElementById(q.answerId).value = this.dataset.value;
                        });
                        choicesDiv.appendChild(button);
                    });
                    const hiddenInput = document.createElement('input');
                    hiddenInput.type = 'hidden';
                    hiddenInput.id = q.answerId;
                    flexGrowDiv.appendChild(choicesDiv);
                    flexGrowDiv.appendChild(hiddenInput);
                } else if (q.type === 'maru_batsu') {
                    const choicesDiv = document.createElement('div');
                    choicesDiv.classList.add('flex', 'space-x-4', 'mt-2');
                    const options = ['ã€‡', 'âœ•'];
                    const colors = {
                        'ã€‡': 'bg-green-600 hover:bg-green-700 text-white',
                        'âœ•': 'bg-red-600 hover:bg-red-700 text-white'
                    };
                    options.forEach(option => {
                        const button = document.createElement('button');
                        button.textContent = option;
                        button.dataset.value = option;
                        button.classList.add('q5-button', 'font-bold', 'text-2xl', 'py-2', 'px-6', 'rounded-full', 'shadow-md', 'transition', 'duration-200', ...colors[option].split(' '));
                        button.addEventListener('click', function() {
                            document.querySelectorAll('.q5-button').forEach(btn => {
                                btn.classList.remove('ring-2', 'ring-offset-2', 'ring-green-500');
                            });
                            this.classList.add('ring-2', 'ring-offset-2', 'ring-green-500');
                            document.getElementById(q.answerId).value = this.dataset.value;
                        });
                        choicesDiv.appendChild(button);
                    });
                    const hiddenInput = document.createElement('input');
                    hiddenInput.type = 'hidden';
                    hiddenInput.id = q.answerId;
                    flexGrowDiv.appendChild(choicesDiv);
                    flexGrowDiv.appendChild(hiddenInput);
                } else if (q.type === 'number_block') {
                    const choicesDiv = document.createElement('div');
                    choicesDiv.classList.add('flex', 'flex-wrap', 'gap-2', 'mt-2', 'justify-center');

                    for (let i = q.min; i <= q.max; i++) {
                        const button = document.createElement('button');
                        button.textContent = i;
                        button.dataset.value = i;
                        button.classList.add(
                            'q6-button', 'w-10', 'h-10', 'flex', 'items-center', 'justify-center',
                            'rounded-md', 'shadow-md', 'font-bold', 'text-white',
                            'transition', 'duration-200', 'hover:scale-105', 'text-lg'
                        );
                        button.style.backgroundColor = getColorForNumber(i, q.min, q.max);
                        button.addEventListener('click', function() {
                            document.querySelectorAll('.q6-button').forEach(btn => {
                                btn.classList.remove('ring-2', 'ring-offset-2', 'ring-blue-500');
                            });
                            this.classList.add('ring-2', 'ring-offset-2', 'ring-blue-500');
                            document.getElementById(q.answerId).value = this.dataset.value;
                        });
                        choicesDiv.appendChild(button);
                    }
                    const hiddenInput = document.createElement('input');
                    hiddenInput.type = 'hidden';
                    hiddenInput.id = q.answerId;
                    flexGrowDiv.appendChild(choicesDiv);
                    flexGrowDiv.appendChild(hiddenInput);
                } else if (q.type === 'no_answer') {
                    // å›ç­”å…¥åŠ›è¦ç´ ã¯ç”Ÿæˆã—ãªã„
                }
                questionItem.appendChild(flexGrowDiv);
                questionsContainer.appendChild(questionItem);

                // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã®å ´åˆã€ç·¨é›†ãƒœã‚¿ãƒ³ã¨å‰Šé™¤ãƒœã‚¿ãƒ³ã€ä¸¦ã¹æ›¿ãˆãƒœã‚¿ãƒ³ã‚’è¿½åŠ 
                if (isEditMode) {
                    questionItem.classList.add('relative'); // ãƒœã‚¿ãƒ³é…ç½®ã®ãŸã‚ã«relativeã‚’è¨­å®š
                    
                    const editControlsContainer = document.createElement('div');
                    editControlsContainer.classList.add('absolute', 'top-2', 'right-2', 'flex', 'space-x-2');

                    // ä¸Šã¸ç§»å‹•ãƒœã‚¿ãƒ³
                    const moveUpButton = document.createElement('button');
                    moveUpButton.textContent = 'â–²';
                    moveUpButton.classList.add('text-xs', 'bg-gray-400', 'hover:bg-gray-500', 'text-white', 'py-1', 'px-2', 'rounded-md', 'shadow-sm');
                    moveUpButton.addEventListener('click', () => moveQuestion(q.id, -1));
                    if (index === 0) moveUpButton.disabled = true; // æœ€åˆã®è³ªå•ã¯ä¸Šã¸ç§»å‹•ä¸å¯
                    editControlsContainer.appendChild(moveUpButton);

                    // ä¸‹ã¸ç§»å‹•ãƒœã‚¿ãƒ³
                    const moveDownButton = document.createElement('button');
                    moveDownButton.textContent = 'â–¼';
                    moveDownButton.classList.add('text-xs', 'bg-gray-400', 'hover:bg-gray-500', 'text-white', 'py-1', 'px-2', 'rounded-md', 'shadow-sm');
                    moveDownButton.addEventListener('click', () => moveQuestion(q.id, 1));
                    if (index === currentQuestionsData.length - 1) moveDownButton.disabled = true; // æœ€å¾Œã®è³ªå•ã¯ä¸‹ã¸ç§»å‹•ä¸å¯
                    editControlsContainer.appendChild(moveDownButton);

                    const editButton = document.createElement('button');
                    editButton.textContent = 'ç·¨é›†';
                    editButton.classList.add('text-xs', 'bg-blue-400', 'hover:bg-blue-500', 'text-white', 'py-1', 'px-2', 'rounded-md', 'shadow-sm');
                    editButton.addEventListener('click', () => toggleQuestionEditing(q.id));
                    editControlsContainer.appendChild(editButton);

                    const deleteButton = document.createElement('button');
                    deleteButton.textContent = 'å‰Šé™¤';
                    deleteButton.classList.add('text-xs', 'bg-red-400', 'hover:bg-red-500', 'text-white', 'py-1', 'px-2', 'rounded-md', 'shadow-sm');
                    deleteButton.addEventListener('click', () => deleteQuestion(q.id));
                    editControlsContainer.appendChild(deleteButton);

                    questionItem.appendChild(editControlsContainer);
                }
            });

            // æ–°è¦è³ªå•è¿½åŠ ãƒœã‚¿ãƒ³ã®è¡¨ç¤º/éè¡¨ç¤º
            const addNewQuestionContainer = document.getElementById('addNewQuestionContainer');
            if (isEditMode) {
                addNewQuestionContainer.classList.remove('hidden');
            } else {
                addNewQuestionContainer.classList.add('hidden');
            }
        }

        /**
         * å€‹åˆ¥ã®è³ªå•ã®ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹é–¢æ•°
         * @param {number} questionId - ç·¨é›†ã™ã‚‹è³ªå•ã®ID
         */
        function toggleQuestionEditing(questionId) {
            const questionItem = document.querySelector(`.question-item[data-question-id="${questionId}"]`);
            if (!questionItem) return;

            // ä»–ã®è³ªå•ãŒç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã®å ´åˆã€ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã™ã‚‹
            document.querySelectorAll('.question-item[data-editing="true"]').forEach(item => {
                const itemId = parseInt(item.dataset.questionId);
                if (itemId !== questionId) {
                    cancelQuestionEditing(itemId); // ä»–ã®è³ªå•ã®ç·¨é›†ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                }
            });

            // ã“ã®è³ªå•ã‚’ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã«ã™ã‚‹
            questionItem.classList.add('editing');
            questionItem.dataset.editing = 'true';

            const questionImageElement = questionItem.querySelector('.question-image'); // This is the <img>
            const flexGrowDiv = questionItem.querySelector('.flex-grow'); // Contains text and answer inputs

            const qIndex = currentQuestionsData.findIndex(q => q.id === questionId);
            const questionData = currentQuestionsData[qIndex];

            // æ—¢å­˜ã®å›ç­”è¡¨ç¤ºUIã‚’å‰Šé™¤ (ã‚‚ã—ã‚ã‚Œã°)
            // (ã“ã‚Œã¯è³ªå•æ–‡ã®ç›´å¾Œã«æ¥ã‚‹å›ç­”å…¥åŠ›è¦ç´ ã‚„é¸æŠè‚¢ãªã©)
            const existingAnswerDisplayElements = flexGrowDiv.querySelectorAll('input[id$="Answer"]:not(.question-text-editor):not(.min-input):not(.max-input), textarea[id$="Answer"]:not(.question-text-editor):not(.options-editor), .space-y-2, .flex.space-x-4, .flex.flex-wrap, input[type="hidden"][id$="Answer"]');
            existingAnswerDisplayElements.forEach(el => el.remove());


            // æ—¢å­˜ã®è³ªå•æ–‡è¦ç´  (pã‚¿ã‚°) ã‚’å‰Šé™¤
            const questionTextElement = questionItem.querySelector('.question-text');
            if (questionTextElement) {
                questionTextElement.remove();
            }

            // æ—¢å­˜ã®ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«å…¥åŠ›è¦ç´ ã‚’å‰Šé™¤ï¼ˆå†è¿½åŠ ã™ã‚‹ãŸã‚ï¼‰
            let existingImageInput = questionItem.querySelector('.question-image-input');
            if (existingImageInput) {
                existingImageInput.remove();
            }

            // ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«å…¥åŠ›è¦ç´ ã‚’å†ä½œæˆã—ã¦ç”»åƒã®ä¸‹ã«é…ç½®
            const newImageFileInput = document.createElement('input');
            newImageFileInput.type = 'file';
            newImageFileInput.accept = 'image/*';
            newImageFileInput.classList.add('mt-2', 'p-1', 'border', 'border-gray-300', 'rounded-md', 'question-image-input');
            questionImageElement.insertAdjacentElement('afterend', newImageFileInput);


            // --- ç·¨é›†UIã‚’æ§‹ç¯‰ ---
            // flexGrowDivã«æ–°ã—ã„ã‚³ãƒ³ãƒ†ãƒŠã‚’ä½œæˆã—ã€ãã®ä¸­ã«è³ªå•æ–‡ã‚¨ãƒ‡ã‚£ã‚¿ã¨ã‚¿ã‚¤ãƒ—é¸æŠã‚’é…ç½®
            const editableContentContainer = document.createElement('div');
            editableContentContainer.classList.add('flex', 'flex-col', 'gap-2', 'mb-2'); // ç¸¦ä¸¦ã³ã«ã—ã¦é–“éš”ã‚’ç©ºã‘ã‚‹

            // è³ªå•æ–‡ã‚¨ãƒ‡ã‚£ã‚¿
            let editorElement;
            if (questionData.type === 'textarea') {
                editorElement = document.createElement('textarea');
                editorElement.rows = 3;
            } else {
                editorElement = document.createElement('input');
                editorElement.type = 'text';
            }
            editorElement.value = questionData.text; // å…ƒã®è³ªå•ãƒ†ã‚­ã‚¹ãƒˆã‚’è¨­å®š
            editorElement.classList.add('w-full', 'p-2', 'border', 'border-gray-300', 'rounded-md', 'focus:outline-none', 'focus:ring-2', 'focus:ring-blue-400', 'question-text-editor');
            editableContentContainer.appendChild(editorElement);

            // è³ªå•å½¢å¼é¸æŠãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³
            const typeSelect = document.createElement('select');
            typeSelect.classList.add('w-full', 'p-2', 'border', 'border-gray-300', 'rounded-md', 'question-type-editor');
            const types = ['text', 'textarea', 'radio', 'yes_no_maybe', 'maru_batsu', 'number_block', 'no_answer'];
            types.forEach(type => {
                const option = document.createElement('option');
                option.value = type;
                option.textContent = type;
                if (questionData.type === type) {
                    option.selected = true;
                }
                typeSelect.appendChild(option);
            });
            editableContentContainer.appendChild(typeSelect);

            // editableContentContainerã‚’flexGrowDivã®å…ˆé ­ã«è¿½åŠ 
            flexGrowDiv.prepend(editableContentContainer);


            // ã‚¿ã‚¤ãƒ—å¤‰æ›´ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ (æ—¢å­˜ã®ãƒ­ã‚¸ãƒƒã‚¯ã‚’ç¶­æŒã—ã¤ã¤ã€EditableContentContainerã®å¾Œã«é…ç½®)
            typeSelect.addEventListener('change', (e) => {
                const newType = e.target.value;
                questionData.type = newType;

                // æ–°ã—ã„ã‚¿ã‚¤ãƒ—ã«åŸºã¥ã„ã¦ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—/ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®š
                if (newType !== 'radio' && newType !== 'yes_no_maybe' && newType !== 'maru_batsu') {
                    delete questionData.options;
                    delete questionData.answerName;
                } else {
                    if (!questionData.options) {
                        if (newType === 'radio') questionData.options = ['é¸æŠè‚¢1', 'é¸æŠè‚¢2'];
                        else if (newType === 'yes_no_maybe') questionData.options = ['YES', 'NO', 'MAYBE'];
                        else if (newType === 'maru_batsu') questionData.options = ['ã€‡', 'âœ•'];
                    }
                    if (newType === 'radio' && !questionData.answerName) {
                        questionData.answerName = `q${questionData.id}_choice`;
                    }
                }

                if (newType !== 'number_block') {
                    delete questionData.min;
                    delete questionData.max;
                } else {
                    if (questionData.min === undefined) questionData.min = 1;
                    if (questionData.max === undefined) questionData.max = 10;
                }
                
                // æ›´æ–°ã•ã‚ŒãŸè³ªå•ãƒ‡ãƒ¼ã‚¿ (ã‚¿ã‚¤ãƒ—å¤‰æ›´ã‚’å«ã‚€) ã‚’LocalStorageã«ä¿å­˜
                saveQuestionsToLocalStorage(currentQuestionsData);

                // å…¨ã¦ã®è³ªå•ã‚’å†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã™ã‚‹ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€å…¨ã¦ã®è³ªå•ã®ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ãŒçµ‚äº†ã™ã‚‹ã€‚
                renderQuestions();

                // å¯¾è±¡ã®è³ªå•ã‚’å†åº¦ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã«ã™ã‚‹ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€æ­£ã—ã„ç·¨é›†UIãŒè¡¨ç¤ºã•ã‚Œã‚‹ã€‚
                toggleQuestionEditing(questionId);
            });


            // ã‚¿ã‚¤ãƒ—ã«å¿œã˜ãŸç·¨é›†UIã‚’editableContentContainerã®å¾Œã«é…ç½®
            // ï¼ˆã“ã“ã§ã¯flexGrowDivã«ç›´æ¥appendã™ã‚‹å½¢ã ãŒã€editableContentContainerã®å¾Œã‚ã«æ¥ã‚‹ï¼‰
            if (questionData.type === 'radio' || questionData.type === 'yes_no_maybe' || questionData.type === 'maru_batsu') {
                const optionsEditor = document.createElement('textarea');
                optionsEditor.rows = 3;
                optionsEditor.placeholder = 'é¸æŠè‚¢ã‚’ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã§å…¥åŠ›ã—ã¦ãã ã•ã„ (ä¾‹: é¸æŠè‚¢1,é¸æŠè‚¢2)';
                optionsEditor.value = questionData.options ? questionData.options.join(',') : '';
                optionsEditor.classList.add('w-full', 'p-2', 'border', 'border-gray-300', 'rounded-md', 'focus:outline-none', 'focus:ring-2', 'focus:ring-blue-400', 'mt-2', 'options-editor');
                flexGrowDiv.appendChild(optionsEditor);
            } else if (questionData.type === 'number_block') {
                const minInput = document.createElement('input');
                minInput.type = 'number';
                minInput.placeholder = 'æœ€å°å€¤';
                minInput.value = questionData.min !== undefined ? questionData.min : '';
                minInput.classList.add('w-1/2', 'p-2', 'border', 'border-gray-300', 'rounded-md', 'focus:outline-none', 'focus:ring-2', 'focus:ring-blue-400', 'mt-2', 'min-input');
                flexGrowDiv.appendChild(minInput);

                const maxInput = document.createElement('input');
                maxInput.type = 'number';
                maxInput.placeholder = 'æœ€å¤§å€¤';
                maxInput.value = questionData.max !== undefined ? questionData.max : '';
                maxInput.classList.add('w-1/2', 'p-2', 'border', 'border-gray-300', 'rounded-md', 'focus:outline-none', 'focus:ring-2', 'focus:ring-blue-400', 'mt-2', 'max-input');
                flexGrowDiv.appendChild(maxInput);
            } else if (questionData.type === 'no_answer') {
                // å›ç­”ãªã—å½¢å¼ã®å ´åˆã€ç‰¹åˆ¥ãªç·¨é›†ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã¯ä¸è¦
                const infoText = document.createElement('p');
                infoText.classList.add('text-sm', 'text-gray-500', 'mt-2');
                infoText.textContent = 'ã“ã®è³ªå•å½¢å¼ã«ã¯å›ç­”æ¬„ãŒã‚ã‚Šã¾ã›ã‚“ã€‚';
                flexGrowDiv.appendChild(infoText);
            }


            // ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒœã‚¿ãƒ³ (ä¿å­˜/ã‚­ãƒ£ãƒ³ã‚»ãƒ«) ã‚’æ›´æ–°
            const editControlsContainer = questionItem.querySelector('.absolute.flex');
            if (editControlsContainer) {
                Array.from(editControlsContainer.children).forEach(child => child.remove()); // å…ƒã®ãƒœã‚¿ãƒ³ã‚’å‰Šé™¤

                const saveButton = document.createElement('button');
                saveButton.textContent = 'ä¿å­˜';
                saveButton.classList.add('text-xs', 'bg-green-600', 'hover:bg-green-700', 'text-white', 'py-1', 'px-2', 'rounded-md', 'shadow-sm');
                saveButton.addEventListener('click', () => saveQuestionChanges(questionId));
                editControlsContainer.appendChild(saveButton);

                const cancelButton = document.createElement('button');
                cancelButton.textContent = 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«';
                cancelButton.classList.add('text-xs', 'bg-gray-400', 'hover:bg-gray-500', 'text-white', 'py-1', 'px-2', 'rounded-md', 'shadow-sm', 'ml-2');
                cancelButton.addEventListener('click', () => cancelQuestionEditing(questionId));
                editControlsContainer.appendChild(cancelButton);
            }
        }

        /**
         * è³ªå•ã®å¤‰æ›´ã‚’ä¿å­˜ã™ã‚‹é–¢æ•°
         * @param {number} questionId - å¤‰æ›´ã‚’ä¿å­˜ã™ã‚‹è³ªå•ã®ID
         */
        function saveQuestionChanges(questionId) {
            const questionItem = document.querySelector(`.question-item[data-question-id="${questionId}"]`);
            if (!questionItem) return;

            const questionTextEditor = questionItem.querySelector('.question-text-editor');
            const imageFileInput = questionItem.querySelector('.question-image-input');
            const typeSelect = questionItem.querySelector('.question-type-editor'); // æ­£ã—ã„ã‚»ãƒ¬ã‚¯ã‚¿ã‚’ä½¿ç”¨

            const qIndex = currentQuestionsData.findIndex(q => q.id === questionId);
            if (qIndex === -1) return;

            // è³ªå•å½¢å¼ã®æ›´æ–°
            currentQuestionsData[qIndex].type = typeSelect ? typeSelect.value : currentQuestionsData[qIndex].type;

            // è³ªå•æ–‡ã®æ›´æ–°
            if (questionTextEditor) {
                currentQuestionsData[qIndex].text = questionTextEditor.value;
            }

            // answerIdã®å‡¦ç†: typeãŒtext, textarea, yes_no_maybe, maru_batsu, number_blockã®å ´åˆã«ã®ã¿è¨­å®š/ç¶­æŒã™ã‚‹
            // no_answerã®å ´åˆã¯answerIdã‚’å‰Šé™¤ã™ã‚‹
            if (currentQuestionsData[qIndex].type === 'text' ||
                currentQuestionsData[qIndex].type === 'textarea' ||
                currentQuestionsData[qIndex].type === 'yes_no_maybe' ||
                currentQuestionsData[qIndex].type === 'maru_batsu' ||
                currentQuestionsData[qIndex].type === 'number_block') {
                // answerIdãŒã¾ã å­˜åœ¨ã—ãªã„å ´åˆã®ã¿è¨­å®š
                if (!currentQuestionsData[qIndex].answerId) {
                    currentQuestionsData[qIndex].answerId = `question${currentQuestionsData[qIndex].id}Answer`;
                }
            } else {
                delete currentQuestionsData[qIndex].answerId;
            }


            // å„è³ªå•ã‚¿ã‚¤ãƒ—ã«å¿œã˜ãŸãƒ‡ãƒ¼ã‚¿ã®æ›´æ–°
            if (currentQuestionsData[qIndex].type === 'radio' || currentQuestionsData[qIndex].type === 'yes_no_maybe' || currentQuestionsData[qIndex].type === 'maru_batsu') {
                const optionsEditor = questionItem.querySelector('.options-editor');
                if (optionsEditor) {
                    currentQuestionsData[qIndex].options = optionsEditor.value.split(',').map(s => s.trim()).filter(s => s !== '');
                } else { // optionsEditorãŒå­˜åœ¨ã—ãªã„å ´åˆã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®š
                    if (currentQuestionsData[qIndex].type === 'radio') currentQuestionsData[qIndex].options = ['é¸æŠè‚¢1', 'é¸æŠè‚¢2'];
                    else if (currentQuestionsData[qIndex].type === 'yes_no_maybe') currentQuestionsData[qIndex].options = ['YES', 'NO', 'MAYBE'];
                    else if (currentQuestionsData[qIndex].type === 'maru_batsu') currentQuestionsData[qIndex].options = ['ã€‡', 'âœ•'];
                }
                // radioã‚¿ã‚¤ãƒ—ã®ã¿answerNameã‚’ä¿æŒ
                if (currentQuestionsData[qIndex].type === 'radio' && !currentQuestionsData[qIndex].answerName) {
                    currentQuestionsData[qIndex].answerName = `q${currentQuestionsData[qIndex].id}_choice`;
                } else if (currentQuestionsData[qIndex].type !== 'radio' && currentQuestionsData[qIndex].answerName) {
                    delete currentQuestionsData[qIndex].answerName;
                }
            } else { // ä»–ã®ã‚¿ã‚¤ãƒ—ã§ã¯options, answerNameã¯ä¸è¦
                delete currentQuestionsData[qIndex].options;
                delete currentQuestionsData[qIndex].answerName;
            }

            if (currentQuestionsData[qIndex].type === 'number_block') {
                const minInput = questionItem.querySelector('.min-input');
                const maxInput = questionItem.querySelector('.max-input');
                if (minInput && maxInput) {
                    currentQuestionsData[qIndex].min = parseInt(minInput.value) || 0;
                    currentQuestionsData[qIndex].max = parseInt(maxInput.value) || 0;
                } else if (currentQuestionsData[qIndex].min === undefined) { // min/maxãŒãªã„å ´åˆã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
                    currentQuestionsData[qIndex].min = 1;
                    currentQuestionsData[qIndex].max = 10;
                }
            } else { // ä»–ã®ã‚¿ã‚¤ãƒ—ã§ã¯min/maxã¯ä¸è¦
                delete currentQuestionsData[qIndex].min;
                delete currentQuestionsData[qIndex].max;
            }

            // ç”»åƒã®æ›´æ–°
            if (imageFileInput && imageFileInput.files.length > 0) {
                const file = imageFileInput.files[0];
                const reader = new FileReader();
                reader.onload = (e) => {
                    currentQuestionsData[qIndex].image = e.target.result; // Base64ãƒ‡ãƒ¼ã‚¿URLã¨ã—ã¦ä¿å­˜
                    saveQuestionsToLocalStorage(currentQuestionsData); // LocalStorageã«ä¿å­˜
                    renderQuestions(); // UIã‚’å†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
                    showMessageBox('è³ªå•ãŒä¿å­˜ã•ã‚Œã¾ã—ãŸã€‚');
                };
                reader.readAsDataURL(file);
            } else {
                saveQuestionsToLocalStorage(currentQuestionsData); // LocalStorageã«ä¿å­˜
                renderQuestions(); // UIã‚’å†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
                showMessageBox('è³ªå•ãŒä¿å­˜ã•ã‚Œã¾ã—ãŸã€‚');
            }
        }

        /**
         * è³ªå•ã®ç·¨é›†ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã™ã‚‹é–¢æ•°
         * @param {number} questionId - ç·¨é›†ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã™ã‚‹è³ªå•ã®ID
         */
        function cancelQuestionEditing(questionId) {
            const questionItem = document.querySelector(`.question-item[data-question-id="${questionId}"]`);
            if (!questionItem) return;

            questionItem.dataset.editing = 'false'; // ç·¨é›†çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
            renderQuestions(); // UIã‚’å…ƒã®çŠ¶æ…‹ã«æˆ»ã™ãŸã‚ã«å†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
            showMessageBox('è³ªå•ã®ç·¨é›†ãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã¾ã—ãŸã€‚');
        }

        /**
         * è³ªå•ã‚’å‰Šé™¤ã™ã‚‹é–¢æ•°
         * @param {number} questionId - å‰Šé™¤ã™ã‚‹è³ªå•ã®ID
         */
        function deleteQuestion(questionId) {
            if (confirm('ã“ã®è³ªå•ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')) {
                currentQuestionsData = currentQuestionsData.filter(q => q.id !== questionId);
                saveQuestionsToLocalStorage(currentQuestionsData);
                renderQuestions();
                showMessageBox('è³ªå•ãŒå‰Šé™¤ã•ã‚Œã¾ã—ãŸã€‚');
            }
        }

        /**
         * è³ªå•ã®é †åºã‚’ç§»å‹•ã™ã‚‹é–¢æ•°
         * @param {number} questionId - ç§»å‹•ã™ã‚‹è³ªå•ã®ID
         * @param {number} direction - ç§»å‹•æ–¹å‘ (1:ä¸‹ã¸, -1:ä¸Šã¸)
         */
        function moveQuestion(questionId, direction) {
            const index = currentQuestionsData.findIndex(q => q.id === questionId);
            if (index === -1) return;

            const newIndex = index + direction;
            if (newIndex >= 0 && newIndex < currentQuestionsData.length) {
                const [movedQuestion] = currentQuestionsData.splice(index, 1); // è³ªå•ã‚’åˆ‡ã‚Šå–ã‚Š
                currentQuestionsData.splice(newIndex, 0, movedQuestion); // æ–°ã—ã„ä½ç½®ã«æŒ¿å…¥
                saveQuestionsToLocalStorage(currentQuestionsData);
                renderQuestions();
                showMessageBox('è³ªå•ã®é †åºãŒå¤‰æ›´ã•ã‚Œã¾ã—ãŸã€‚');
            }
        }

        /**
         * æ–°è¦è³ªå•ã‚’è¿½åŠ ã™ã‚‹é–¢æ•°
         */
        function addNewQuestion() {
            const newId = currentQuestionsData.length > 0 ? Math.max(...currentQuestionsData.map(q => q.id)) + 1 : 1;
            const newQuestion = {
                id: newId,
                type: 'text', // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯ãƒ†ã‚­ã‚¹ãƒˆå½¢å¼
                text: `æ–°è¦è³ªå• ${newId}`,
                image: 'https://placehold.co/80x80/EEEEEE/555555?text=New', // æ–°è¦è³ªå•ç”¨ã®ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼
                answerId: `question${newId}Answer`
            };
            currentQuestionsData.push(newQuestion);
            saveQuestionsToLocalStorage(currentQuestionsData);
            renderQuestions();
            showMessageBox('æ–°ã—ã„è³ªå•ãŒè¿½åŠ ã•ã‚Œã¾ã—ãŸã€‚');
        }


        /**
         * è³ªå•ãƒ‡ãƒ¼ã‚¿ã‚’LocalStorageã«ä¿å­˜ã™ã‚‹é–¢æ•°
         * @param {Array} data - ä¿å­˜ã™ã‚‹è³ªå•ãƒ‡ãƒ¼ã‚¿é…åˆ—
         */
        function saveQuestionsToLocalStorage(data) {
            try {
                localStorage.setItem(`${APP_ID}_questionsData`, JSON.stringify(data));
                console.log('è³ªå•ãƒ‡ãƒ¼ã‚¿ã‚’LocalStorageã«ä¿å­˜ã—ã¾ã—ãŸã€‚');
            } catch (e) {
                console.error('LocalStorageã¸ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ:', e);
                showMessageBox('è³ªå•ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ãŒä¸Šé™ã«é”ã—ã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚', true);
            }
        }

        /**
         * è³ªå•ãƒ‡ãƒ¼ã‚¿ã‚’LocalStorageã‹ã‚‰èª­ã¿è¾¼ã‚€é–¢æ•°
         * @returns {Array|null} èª­ã¿è¾¼ã‚“ã è³ªå•ãƒ‡ãƒ¼ã‚¿é…åˆ—ã€ã¾ãŸã¯null
         */
        function loadQuestionsFromLocalStorage() {
            try {
                const storedData = localStorage.getItem(`${APP_ID}_questionsData`);
                if (storedData) {
                    const parsedData = JSON.parse(storedData);
                    console.log('è³ªå•ãƒ‡ãƒ¼ã‚¿ã‚’LocalStorageã‹ã‚‰èª­ã¿è¾¼ã¿ã¾ã—ãŸã€‚');
                    return parsedData;
                }
            } catch (e) {
                console.error('LocalStorageã‹ã‚‰ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ:', e);
                showMessageBox('è³ªå•ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ‡ãƒ¼ã‚¿ãŒç ´æã—ã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚', true);
            }
            return null;
        }

        /**
         * ç¾åœ¨ã®å›ç­”å†…å®¹ã‚’ä¸€æ™‚ä¿å­˜ã™ã‚‹é–¢æ•°
         */
        function saveTemporaryAnswers() {
            const tempAnswers = {};
            currentQuestionsData.forEach(q => {
                let answer = '';
                if (q.type === 'text' || q.type === 'textarea' || q.type === 'yes_no_maybe' || q.type === 'maru_batsu' || q.type === 'number_block') {
                    const inputElement = document.getElementById(q.answerId);
                    if (inputElement) {
                        answer = inputElement.value;
                    }
                } else if (q.type === 'radio') {
                    const checkedRadio = document.querySelector(`input[name="${q.answerName}"]:checked`);
                    if (checkedRadio) {
                        answer = checkedRadio.value;
                    }
                }
                // no_answerã‚¿ã‚¤ãƒ—ã‚‚ç©ºæ–‡å­—åˆ—ã‚’ä¿å­˜
                tempAnswers[q.id] = answer;
            });
            try {
                localStorage.setItem(`${APP_ID}_temporaryAnswers`, JSON.stringify(tempAnswers));
                showMessageBox('å›ç­”ã‚’ä¸€æ™‚ä¿å­˜ã—ã¾ã—ãŸã€‚');
            } catch (e) {
                console.error('ä¸€æ™‚å›ç­”ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ:', e);
                showMessageBox('ä¸€æ™‚å›ç­”ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ãŒä¸Šé™ã«é”ã—ã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚', true);
            }
        }

        /**
         * ä¸€æ™‚ä¿å­˜ã•ã‚ŒãŸå›ç­”å†…å®¹ã‚’å¾©å…ƒã™ã‚‹é–¢æ•°
         */
        function loadTemporaryAnswers() {
            try {
                const storedTempAnswers = localStorage.getItem(`${APP_ID}_temporaryAnswers`);
                if (storedTempAnswers) {
                    const tempAnswers = JSON.parse(storedTempAnswers);
                    let restoredCount = 0;
                    currentQuestionsData.forEach(q => {
                        const answer = tempAnswers[q.id];
                        if (answer !== undefined) { // answerãŒnull, undefined, "" ã®å ´åˆã‚‚è€ƒæ…®
                            if (q.type === 'text' || q.type === 'textarea') {
                                const inputElement = document.getElementById(q.answerId);
                                if (inputElement) {
                                    inputElement.value = answer;
                                    restoredCount++;
                                }
                            } else if (q.type === 'radio') {
                                const radioToSelect = document.querySelector(`input[name="${q.answerName}"][value="${answer}"]`);
                                if (radioToSelect) {
                                    radioToSelect.checked = true;
                                    restoredCount++;
                                }
                            } else if (q.type === 'yes_no_maybe') {
                                const hiddenInput = document.getElementById(q.answerId);
                                if (hiddenInput) {
                                    hiddenInput.value = answer;
                                    // å¯¾å¿œã™ã‚‹ãƒœã‚¿ãƒ³ã®è¦–è¦šçš„é¸æŠã‚’å¾©å…ƒ
                                    // æ—¢å­˜ã®ãƒªãƒ³ã‚°ã‚¯ãƒ©ã‚¹ã‚’å…¨ã¦å‰Šé™¤ã—ã¦ã‹ã‚‰é©ç”¨
                                    const questionItem = document.querySelector(`.question-item[data-question-id="${q.id}"]`);
                                    if (questionItem) {
                                        questionItem.querySelectorAll('.q4-button').forEach(btn => {
                                            btn.classList.remove('ring-2', 'ring-offset-2', 'ring-blue-500');
                                        });
                                        const button = questionItem.querySelector(`.q4-button[data-value="${answer}"]`);
                                        if (button) {
                                            button.classList.add('ring-2', 'ring-offset-2', 'ring-blue-500');
                                            restoredCount++;
                                        }
                                    }
                                }
                            } else if (q.type === 'maru_batsu') {
                                const hiddenInput = document.getElementById(q.answerId);
                                if (hiddenInput) {
                                    hiddenInput.value = answer;
                                    const questionItem = document.querySelector(`.question-item[data-question-id="${q.id}"]`);
                                    if (questionItem) {
                                        questionItem.querySelectorAll('.q5-button').forEach(btn => {
                                            btn.classList.remove('ring-2', 'ring-offset-2', 'ring-green-500');
                                        });
                                        const button = questionItem.querySelector(`.q5-button[data-value="${answer}"]`);
                                        if (button) {
                                            button.classList.add('ring-2', 'ring-offset-2', 'ring-green-500');
                                            restoredCount++;
                                        }
                                    }
                                }
                            } else if (q.type === 'number_block') {
                                const hiddenInput = document.getElementById(q.answerId);
                                if (hiddenInput) {
                                    hiddenInput.value = answer;
                                    const questionItem = document.querySelector(`.question-item[data-question-id="${q.id}"]`);
                                    if (questionItem) {
                                        questionItem.querySelectorAll('.q6-button').forEach(btn => {
                                            btn.classList.remove('ring-2', 'ring-offset-2', 'ring-blue-500');
                                        });
                                        const button = questionItem.querySelector(`.q6-button[data-value="${answer}"]`);
                                        if (button) {
                                            button.classList.add('ring-2', 'ring-offset-2', 'ring-blue-500');
                                            restoredCount++;
                                        }
                                    }
                                }
                            } else if (q.type === 'no_answer') {
                                // å›ç­”ãªã—å½¢å¼ãªã®ã§ç‰¹ã«UIã®å¾©å…ƒã¯ä¸è¦ã ãŒã€å›ç­”ãŒå­˜åœ¨ã™ã‚Œã°å¾©å…ƒã‚«ã‚¦ãƒ³ãƒˆ
                                restoredCount++;
                            }
                        }
                    });
                    if (restoredCount > 0) {
                        showMessageBox('ä¸€æ™‚ä¿å­˜ã•ã‚ŒãŸå›ç­”ã‚’å¾©å…ƒã—ã¾ã—ãŸã€‚');
                    }
                }
            } catch (e) {
                console.error('ä¸€æ™‚å›ç­”ã®å¾©å…ƒã«å¤±æ•—ã—ã¾ã—ãŸ:', e);
                showMessageBox('ä¸€æ™‚å›ç­”ã®å¾©å…ƒã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ‡ãƒ¼ã‚¿ãŒç ´æã—ã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚', true);
            }
        }


        /**
         * ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
         * @param {string} filename - ãƒ•ã‚¡ã‚¤ãƒ«å
         * @param {string|Blob} data - ãƒ•ã‚¡ã‚¤ãƒ«ã®å†…å®¹ (ãƒ†ã‚­ã‚¹ãƒˆã¾ãŸã¯Blob)
         * @param {string} mimeType - MIMEã‚¿ã‚¤ãƒ— (ä¾‹: 'text/plain', 'image/png')
         */
        function downloadFile(filename, data, mimeType) {
            const blob = new Blob([data], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // --- ç”»åƒæ‹¡å¤§è¡¨ç¤ºé–¢é€£ã®é–¢æ•° ---
        const imageOverlay = document.getElementById('imageOverlay');
        const enlargedImage = document.getElementById('enlargedImage');
        const closeOverlayButton = document.getElementById('closeOverlayButton');

        /**
         * ç”»åƒã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚’è¡¨ç¤ºã™ã‚‹é–¢æ•°
         * @param {string} imageUrl - æ‹¡å¤§è¡¨ç¤ºã™ã‚‹ç”»åƒã®URL
         */
        function showImageOverlay(imageUrl) {
            enlargedImage.src = imageUrl;
            imageOverlay.classList.add('show');
            document.body.style.overflow = 'hidden'; // èƒŒæ™¯ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’ç¦æ­¢
        }

        /**
         * ç”»åƒã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚’éè¡¨ç¤ºã«ã™ã‚‹é–¢æ•°
         */
        function hideImageOverlay() {
            imageOverlay.classList.remove('show');
            document.body.style.overflow = ''; // èƒŒæ™¯ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’è¨±å¯
            enlargedImage.src = ''; // ç”»åƒã‚’ã‚¯ãƒªã‚¢
        }

        document.addEventListener('DOMContentLoaded', function() {
            const backgroundMusic = document.getElementById('backgroundMusic');
            const musicToggleButton = document.getElementById('musicToggleButton');
            let isPlaying = true;

            // ãƒ–ãƒ©ã‚¦ã‚¶ã®è‡ªå‹•å†ç”Ÿãƒãƒªã‚·ãƒ¼ã«ã‚ˆã‚Šã€æ‰‹å‹•ã§å†ç”Ÿã‚’é–‹å§‹ã™ã‚‹å¿…è¦ãŒã‚ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚
            // ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰æ™‚ã«å†ç”Ÿã‚’è©¦ã¿ã€å¤±æ•—ã—ãŸå ´åˆã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«æ“ä½œã‚’ä¿ƒã—ã¾ã™ã€‚
            backgroundMusic.play().catch(error => {
                console.log("è‡ªå‹•å†ç”ŸãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¾ã—ãŸ:", error);
                // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«å†ç”Ÿã‚’ä¿ƒã™ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãªã©ã‚’è¡¨ç¤ºã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™
            });

            // éŸ³æ¥½ãŒçµ‚äº†ã—ãŸã¨ãã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
            backgroundMusic.addEventListener('ended', function() {
                // 5ç§’å¾Œã«éŸ³æ¥½ã‚’å†é–‹
                setTimeout(() => {
                    if (isPlaying) { // éŸ³æ¥½ãŒå†ç”ŸçŠ¶æ…‹ã®å ´åˆã®ã¿å†é–‹
                        backgroundMusic.play();
                    }
                }, 5000); // 5000ãƒŸãƒªç§’ = 5ç§’
            });

            musicToggleButton.addEventListener('click', function() {
                if (isPlaying) {
                    backgroundMusic.pause();
                    musicToggleButton.textContent = 'ğŸµ éŸ³æ¥½ã‚’å†ç”Ÿ';
                } else {
                    backgroundMusic.play();
                    musicToggleButton.textContent = 'ğŸµ éŸ³æ¥½ã‚’åœæ­¢';
                }
                isPlaying = !isPlaying;
            });

            const dateTimeInput = document.getElementById('dateTimeInput');
            const saveAnswersButton = document.getElementById('saveAnswersButton');
            const outputQuestionsButton = document.getElementById('outputQuestionsButton');
            const inputQuestionsButton = document.getElementById('inputQuestionsButton');
            const editQuestionsButton = document.getElementById('editQuestionsButton');
            const addNewQuestionButton = document.getElementById('addNewQuestionButton');
            const temporarySaveButton = document.getElementById('temporarySaveButton'); // æ–°ã—ã„ãƒœã‚¿ãƒ³


            // --- ç”»åƒã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ ---
            // ã€Œâœ•ã€ãƒœã‚¿ãƒ³ã§é–‰ã˜ã‚‹
            closeOverlayButton.addEventListener('click', hideImageOverlay);
            // ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤èƒŒæ™¯ã®ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹ (ç”»åƒè‡ªä½“ã¯é™¤ã)
            imageOverlay.addEventListener('click', (event) => {
                if (event.target === imageOverlay) { // ã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸã®ãŒã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤è‡ªä½“ã®å ´åˆ
                    hideImageOverlay();
                }
            });


            // ç¾åœ¨ã®æ—¥æ™‚ã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã¨ã—ã¦è¨­å®š
            const now = new Date();
            now.setMinutes(now.getMinutes() - now.getTimezoneOffset()); // UTCã‹ã‚‰ãƒ­ãƒ¼ã‚«ãƒ«ã‚¿ã‚¤ãƒ ã¸ã®ã‚ªãƒ•ã‚»ãƒƒãƒˆã‚’èª¿æ•´
            dateTimeInput.value = now.toISOString().slice(0, 16);

            // ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰æ™‚ã«è³ªå•ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã€ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
            const storedQuestions = loadQuestionsFromLocalStorage();
            if (storedQuestions && storedQuestions.length > 0) {
                currentQuestionsData = storedQuestions;
            } else {
                currentQuestionsData = initialQuestionsData;
                saveQuestionsToLocalStorage(currentQuestionsData); // åˆå›ãƒ­ãƒ¼ãƒ‰æ™‚ã«åˆæœŸãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
            }
            renderQuestions(); // è³ªå•ã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
            loadTemporaryAnswers(); // è³ªå•ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°å¾Œã«ä¸€æ™‚ä¿å­˜ã•ã‚ŒãŸå›ç­”ã‚’å¾©å…ƒ


            // å›ç­”ã‚’ä¿å­˜ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
            saveAnswersButton.addEventListener('click', function() {
                // æ—¥æ™‚ã‚’å–å¾—ã—ã€yy_mmddå½¢å¼ã«ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
                const selectedDateTime = new Date(dateTimeInput.value);
                const year = String(selectedDateTime.getFullYear()).slice(-2);
                const month = String(selectedDateTime.getMonth() + 1).padStart(2, '0');
                const day = String(selectedDateTime.getDate()).padStart(2, '0');
                const formattedDate = `${year}_${month}${day}`;

                const answers = [];
                currentQuestionsData.forEach(q => {
                    let answer = '';
                    if (q.type === 'text' || q.type === 'yes_no_maybe' || q.type === 'maru_batsu' || q.type === 'number_block') {
                        const inputElement = document.getElementById(q.answerId);
                        if (inputElement) {
                            answer = inputElement.value;
                        }
                    } else if (q.type === 'textarea') {
                        const textareaElement = document.getElementById(q.answerId);
                        if (textareaElement) {
                            // æ”¹è¡Œã‚³ãƒ¼ãƒ‰ã‚’LFã«çµ±ä¸€
                            let processedAnswer = textareaElement.value.replace(/\r\n|\r/g, '\n');
                            // ãƒ€ãƒ–ãƒ«ã‚¯ã‚©ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—
                            processedAnswer = processedAnswer.replace(/"/g, '""');
                            // ã‚¿ãƒ–æ–‡å­—ã‚„æ”¹è¡ŒãŒå«ã¾ã‚Œã‚‹å ´åˆã€å…¨ä½“ã‚’ãƒ€ãƒ–ãƒ«ã‚¯ã‚©ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã§å›²ã‚€
                            if (processedAnswer.includes('\t') || processedAnswer.includes('\n')) {
                                processedAnswer = `"${processedAnswer}"`;
                            }
                            answer = processedAnswer;
                        }
                    } else if (q.type === 'radio') {
                        const checkedRadio = document.querySelector(`input[name="${q.answerName}"]:checked`);
                        if (checkedRadio) {
                            answer = checkedRadio.value;
                        }
                    } else if (q.type === 'no_answer') {
                        answer = ''; // å›ç­”ãªã—å½¢å¼ã®å ´åˆã¯ç©ºæ–‡å­—åˆ—ã‚’ä¿å­˜
                    }
                    answers.push(answer);
                });

                // ã‚¿ãƒ–åŒºåˆ‡ã‚Šå½¢å¼ã®ãƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆ
                const data = `${formattedDate}\t${answers.join('\t')}`;

                // Blobã‚’ä½œæˆã—ã€ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒªãƒ³ã‚¯ã‚’ç”Ÿæˆ
                const blob = new Blob([data], { type: 'text/plain;charset=utf-8' });
                const url = URL.createObjectURL(blob);

                // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ç”¨ã®aè¦ç´ ã‚’ä½œæˆã—ã€ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                const a = document.createElement('a');
                a.href = url;
                a.download = `å›ç­”ãƒ‡ãƒ¼ã‚¿_${formattedDate}.txt`; // ãƒ•ã‚¡ã‚¤ãƒ«å
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url); // URLã‚’è§£æ”¾
                showMessageBox('å›ç­”ãŒä¿å­˜ã•ã‚Œã¾ã—ãŸã€‚');
            });

            // ã€Œå‡ºåŠ›ã€ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
            outputQuestionsButton.addEventListener('click', function() {
                // ã™ã¹ã¦ã®è³ªå•ãƒ‡ãƒ¼ã‚¿ã‚’å˜ä¸€ã®JSONãƒ•ã‚¡ã‚¤ãƒ«ã«ã¾ã¨ã‚ã‚‹
                const allQuestionsData = {
                    questions: currentQuestionsData.map(q => {
                        // ç”»åƒãƒ‡ãƒ¼ã‚¿ãŒBase64ã§ãªã„å ´åˆã€ãƒ€ãƒŸãƒ¼Base64ã«å¤‰æ›ã—ã¦ä¿å­˜
                        const imageToSave = q.image && q.image.startsWith('data:image/') ? q.image : 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII=';
                        return { ...q, image: imageToSave };
                    })
                };
                downloadFile('all_questions_data.json', JSON.stringify(allQuestionsData, null, 2), 'application/json;charset=utf-8');
                showMessageBox('ã™ã¹ã¦ã®è³ªå•ãƒ‡ãƒ¼ã‚¿ãŒå˜ä¸€ã®JSONãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦å‡ºåŠ›ã•ã‚Œã¾ã—ãŸã€‚');
            });

            // éš ã—ãƒ•ã‚¡ã‚¤ãƒ«å…¥åŠ›è¦ç´ ã®ä½œæˆ
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.multiple = false; // å˜ä¸€ãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿é¸æŠã‚’è¨±å¯
            fileInput.accept = '.json'; // JSONãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿ã‚’å—ã‘å…¥ã‚Œã‚‹
            fileInput.style.display = 'none'; // éè¡¨ç¤ºã«ã™ã‚‹
            document.body.appendChild(fileInput);

            // ã€Œå…¥åŠ›ã€ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
            inputQuestionsButton.addEventListener('click', function() {
                fileInput.click(); // éš ã—ãƒ•ã‚¡ã‚¤ãƒ«å…¥åŠ›è¦ç´ ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’é–‹ã
            });

            // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠæ™‚ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
            fileInput.addEventListener('change', async function(event) {
                const files = event.target.files;
                if (files.length === 0) {
                    return;
                }

                const file = files[0]; // å˜ä¸€ãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿ã‚’å‡¦ç†
                if (file.name !== 'all_questions_data.json') {
                    showMessageBox('é¸æŠã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã¯ "all_questions_data.json" ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚æ­£ã—ã„ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚', true);
                    fileInput.value = '';
                    return;
                }

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const loadedData = JSON.parse(e.target.result);
                        if (loadedData.questions && Array.isArray(loadedData.questions)) {
                            currentQuestionsData = loadedData.questions;
                            renderQuestions();
                            saveQuestionsToLocalStorage(currentQuestionsData);
                            showMessageBox('è³ªå•ãŒæ­£å¸¸ã«å¾©å…ƒã•ã‚Œã¾ã—ãŸã€‚');
                        } else {
                            showMessageBox('JSONãƒ•ã‚¡ã‚¤ãƒ«ã®å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚', true);
                        }
                    } catch (error) {
                        console.error("JSONãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‘ãƒ¼ã‚¹ã«å¤±æ•—ã—ã¾ã—ãŸ:", error);
                        showMessageBox('JSONãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ•ã‚¡ã‚¤ãƒ«ãŒç ´æã—ã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚', true);
                    }
                };
                reader.onerror = (e) => {
                    console.error("ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:", file.name, e);
                    showMessageBox(`ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${file.name}`, true);
                };
                reader.readAsText(file); // JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ†ã‚­ã‚¹ãƒˆã¨ã—ã¦èª­ã¿è¾¼ã‚€
                fileInput.value = ''; // åŒã˜ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å†åº¦é¸æŠã§ãã‚‹ã‚ˆã†ã«inputã‚’ã‚¯ãƒªã‚¢
            });

            // ã€Œç·¨é›†ã€ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
            editQuestionsButton.addEventListener('click', function() {
                isEditMode = !isEditMode; // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹
                if (isEditMode) {
                    editQuestionsButton.textContent = 'ç·¨é›†ãƒ¢ãƒ¼ãƒ‰çµ‚äº†';
                    editQuestionsButton.classList.remove('bg-gray-600', 'hover:bg-gray-700');
                    editQuestionsButton.classList.add('bg-orange-600', 'hover:bg-orange-700');
                    showMessageBox('ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã«å…¥ã‚Šã¾ã—ãŸã€‚å„è³ªå•ã®å³ä¸Šã«ç·¨é›†ãƒ»å‰Šé™¤ãƒ»ä¸¦ã¹æ›¿ãˆãƒœã‚¿ãƒ³ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚');
                } else {
                    editQuestionsButton.textContent = 'ç·¨é›†';
                    editQuestionsButton.classList.remove('bg-orange-600', 'hover:bg-orange-700');
                    editQuestionsButton.classList.add('bg-gray-600', 'hover:bg-gray-700');
                    saveQuestionsToLocalStorage(currentQuestionsData); // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰çµ‚äº†æ™‚ã«ä¿å­˜
                    showMessageBox('ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã‚’çµ‚äº†ã—ã¾ã—ãŸã€‚å¤‰æ›´ãŒä¿å­˜ã•ã‚Œã¾ã—ãŸã€‚');
                }
                renderQuestions(); // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã®åˆ‡ã‚Šæ›¿ãˆã«åˆã‚ã›ã¦è³ªå•ã‚’å†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
            });

            // ã€Œæ–°è¦è³ªå•ã‚’è¿½åŠ ã€ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
            addNewQuestionButton.addEventListener('click', addNewQuestion);

            // ã€Œä¸€æ™‚ä¿å­˜ã€ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
            temporarySaveButton.addEventListener('click', saveTemporaryAnswers);
        });
    </script>
</body>
</html>
